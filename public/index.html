<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Control by ZK - ãƒ‡ãƒ¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .status-section {
            margin-bottom: 40px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border-left: 4px solid #4f46e5;
        }

        .demo-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5rem;
            color: #1e293b;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: #4f46e5;
            margin-right: 12px;
            border-radius: 2px;
        }

        .button {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .button.secondary {
            background: #64748b;
        }

        .button.success {
            background: #10b981;
        }

        .button.danger {
            background: #ef4444;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #4f46e5;
        }

        .form-textarea {
            resize: vertical;
            min-height: 120px;
        }

        .result-section {
            margin-top: 30px;
            padding: 20px;
            background: #f1f5f9;
            border-radius: 12px;
            display: none;
        }

        .result-section.show {
            display: block;
        }

        .result-section.success {
            background: #ecfdf5;
            border-left: 4px solid #10b981;
        }

        .result-section.error {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
        }

        .result-section.warning {
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
        }

        /* Progress Tracking Styles */
        .progress-container {
            margin: 20px 0;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .progress-step {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .progress-step.pending {
            background: #f1f5f9;
            color: #64748b;
        }

        .progress-step.active {
            background: #dbeafe;
            color: #1d4ed8;
            border-left: 4px solid #3b82f6;
        }

        .progress-step.completed {
            background: #ecfdf5;
            color: #059669;
            border-left: 4px solid #10b981;
        }

        .progress-step.failed {
            background: #fef2f2;
            color: #dc2626;
            border-left: 4px solid #ef4444;
        }

        .progress-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 12px;
        }

        .progress-step.pending .progress-icon {
            background: #e2e8f0;
        }

        .progress-step.active .progress-icon {
            background: #3b82f6;
            color: white;
        }

        .progress-step.completed .progress-icon {
            background: #10b981;
            color: white;
        }

        .progress-step.failed .progress-icon {
            background: #ef4444;
            color: white;
        }

        .step-details {
            margin-left: 32px;
            margin-top: 8px;
            font-size: 14px;
            color: #64748b;
        }

        .transaction-link {
            color: #3b82f6;
            text-decoration: none;
            font-family: monospace;
            font-size: 12px;
        }

        .transaction-link:hover {
            text-decoration: underline;
        }

        .json-viewer {
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin-top: 12px;
        }

        .json-key {
            color: #7dd3fc;
        }

        .json-string {
            color: #86efac;
        }

        .json-number {
            color: #fbbf24;
        }

        .json-boolean {
            color: #f472b6;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .status-card {
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-indicator.online {
            background: #10b981;
        }

        .status-indicator.offline {
            background: #ef4444;
        }

        .status-indicator.unknown {
            background: #64748b;
        }

        .history-section {
            margin-top: 40px;
        }

        .history-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #e5e7eb;
        }

        .history-item.completed {
            border-left-color: #10b981;
        }

        .history-item.failed {
            border-left-color: #ef4444;
        }

        .history-item.pending {
            border-left-color: #f59e0b;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 30px;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #4f46e5;
            border-bottom: 2px solid #4f46e5;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AI Control by ZK</h1>
            <p>AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã‚ˆã‚‹è‡ªå‹•æ”¯æ‰•ã„ã‚’ZKPã§åˆ¶å¾¡ã™ã‚‹ãƒ‡ãƒ¢ã‚·ã‚¹ãƒ†ãƒ </p>
        </div>

        <div class="content">
            <!-- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="status-section">
                <h2 class="section-title">ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h2>
                <button class="button secondary" onclick="checkStatus()">çŠ¶æ…‹æ›´æ–°</button>
                <div id="systemStatus" class="status-grid">
                    <div class="status-card">
                        <div><span class="status-indicator unknown"></span>åˆæœŸåŒ–ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('demo')">ğŸ¯ ãƒ‡ãƒ¢å®Ÿè¡Œ</button>
                <button class="tab" onclick="showTab('history')">ğŸ“Š å±¥æ­´</button>
            </div>

            <!-- ãƒ‡ãƒ¢ã‚¿ãƒ– -->
            <div id="demo-tab" class="tab-content active">
                <div class="demo-section">
                    <h2 class="section-title">ğŸ¯ ãƒ‡ãƒ¢å®Ÿè¡Œ</h2>
                    <p style="margin-bottom: 20px; color: #64748b;">
                        å®Œå…¨ãªãƒ•ãƒ­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ï¼šãƒ«ãƒ¼ãƒ«ã‚³ãƒŸãƒƒãƒˆ â†’ è«‹æ±‚æ›¸è§£æ â†’ ZKPè¨¼æ˜ â†’ ã‚ªãƒ³ãƒã‚§ãƒ¼ãƒ³æ¤œè¨¼ â†’ Base Sepoliaæ”¯æ‰•ã„
                    </p>
                    
                    <div class="form-group">
                        <label class="form-label">æ”¯æ‰•ã„ãƒ«ãƒ¼ãƒ«è¨­å®š:</label>
                        <button class="button secondary" onclick="loadSampleRules()">ã‚µãƒ³ãƒ—ãƒ«ãƒ«ãƒ¼ãƒ«èª­è¾¼</button>
                        <textarea class="form-textarea" id="demoRulesInput" placeholder="ãƒ«ãƒ¼ãƒ«ã‚’JSONå½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">è«‹æ±‚æ›¸ãƒ†ã‚­ã‚¹ãƒˆ:</label>
                        <button class="button secondary" onclick="loadSampleInvoice()">ã‚µãƒ³ãƒ—ãƒ«è«‹æ±‚æ›¸èª­è¾¼</button>
                        <textarea class="form-textarea" id="demoInvoiceInput" placeholder="è«‹æ±‚æ›¸ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
                    </div>
                    
                    <button class="button" onclick="runDemoWithUserInput()" id="demoButton">
                        ğŸš€ ãƒ‡ãƒ¢å®Ÿè¡Œ
                    </button>
                </div>

                <!-- Progress Tracking -->
                <div id="progressContainer" class="progress-container" style="display: none;">
                    <h3>ğŸ”„ å®Ÿè¡Œé€²æ—</h3>
                    <div id="progressSteps">
                        <div id="step-commit" class="progress-step pending">
                            <div class="progress-icon">1</div>
                            <div>
                                <strong>ãƒ«ãƒ¼ãƒ«ã‚³ãƒŸãƒƒãƒˆ</strong>
                                <div class="step-details" id="details-commit">ã‚ªãƒ³ãƒã‚§ãƒ¼ãƒ³ãƒ«ãƒ¼ãƒ«è¨˜éŒ²ã‚’æº–å‚™ä¸­...</div>
                            </div>
                        </div>
                        <div id="step-parse" class="progress-step pending">
                            <div class="progress-icon">2</div>
                            <div>
                                <strong>è«‹æ±‚æ›¸è§£æ</strong>
                                <div class="step-details" id="details-parse">AIè§£æã‚’å¾…æ©Ÿä¸­...</div>
                            </div>
                        </div>
                        <div id="step-zkp" class="progress-step pending">
                            <div class="progress-icon">3</div>
                            <div>
                                <strong>ZKPè¨¼æ˜ç”Ÿæˆ</strong>
                                <div class="step-details" id="details-zkp">ã‚¼ãƒ­çŸ¥è­˜è¨¼æ˜ã‚’æº–å‚™ä¸­...</div>
                            </div>
                        </div>
                        <div id="step-verify" class="progress-step pending">
                            <div class="progress-icon">4</div>
                            <div>
                                <strong>ã‚ªãƒ³ãƒã‚§ãƒ¼ãƒ³æ¤œè¨¼</strong>
                                <div class="step-details" id="details-verify">Base Sepoliaæ¤œè¨¼ã‚’å¾…æ©Ÿä¸­...</div>
                            </div>
                        </div>
                        <div id="step-payment" class="progress-step pending">
                            <div class="progress-icon">5</div>
                            <div>
                                <strong>USDCæ”¯æ‰•ã„</strong>
                                <div class="step-details" id="details-payment">æ”¯æ‰•ã„å®Ÿè¡Œã‚’å¾…æ©Ÿä¸­...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å±¥æ­´ã‚¿ãƒ– -->
            <div id="history-tab" class="tab-content">
                <div class="history-section">
                    <h2 class="section-title">ğŸ“Š æ”¯æ‰•ã„å±¥æ­´</h2>
                    <button class="button secondary" onclick="loadHistory()">å±¥æ­´æ›´æ–°</button>
                    <div id="historyContainer">
                        <p style="color: #64748b;">å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>
            </div>

            <!-- çµæœè¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="resultSection" class="result-section">
                <h3>å‡¦ç†çµæœ</h3>
                <div id="resultContent"></div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentTab = 'demo';

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkStatus();
            loadHistory();
        });

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');

            // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');

            currentTab = tabName;
        }

        // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        async function checkStatus() {
            try {
                const response = await fetch('/api/status');
                const result = await response.json();
                
                if (result.success) {
                    displaySystemStatus(result.data);
                } else {
                    showResult('ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error, 'error');
                }
            } catch (error) {
                showResult('ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹è¡¨ç¤º
        function displaySystemStatus(status) {
            const statusContainer = document.getElementById('systemStatus');
            
            // USDCæ®‹é«˜ã®ã¿è¡¨ç¤º
            if (status.balance !== null) {
                statusContainer.innerHTML = `
                    <div class="status-card">
                        <div>ğŸ’° USDCæ®‹é«˜</div>
                        <div style="font-size: 1.2rem; font-weight: bold; margin-top: 5px;">
                            ${status.balance} USDC
                        </div>
                    </div>
                `;
            } else {
                statusContainer.innerHTML = `
                    <div class="status-card">
                        <div>ğŸ’° USDCæ®‹é«˜</div>
                        <div style="font-size: 1.2rem; font-weight: bold; margin-top: 5px; color: #ef4444;">
                            å–å¾—ä¸­...
                        </div>
                    </div>
                `;
            }
        }

        // ãƒ‡ãƒ¢å®Ÿè¡Œ
        async function runDemo() {
            const button = document.getElementById('demoButton');
            button.disabled = true;
            button.innerHTML = '<span class="loading"></span>ãƒ‡ãƒ¢å®Ÿè¡Œä¸­...';

            try {
                const response = await fetch('/api/demo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    showResult('ãƒ‡ãƒ¢å®Ÿè¡Œå®Œäº†ï¼', 'success', result.data);
                    loadHistory(); // å±¥æ­´ã‚’æ›´æ–°
                } else {
                    showResult('ãƒ‡ãƒ¢å®Ÿè¡Œå¤±æ•—: ' + result.error, 'error');
                }
            } catch (error) {
                showResult('ãƒ‡ãƒ¢å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = 'ğŸš€ ãƒ‡ãƒ¢å®Ÿè¡Œ';
            }
        }

        // ã‚µãƒ³ãƒ—ãƒ«ãƒ«ãƒ¼ãƒ«èª­ã¿è¾¼ã¿
        async function loadSampleRules() {
            try {
                const response = await fetch('/api/sample-rules');
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('demoRulesInput').value = JSON.stringify(result.data, null, 2);
                }
            } catch (error) {
                showResult('ã‚µãƒ³ãƒ—ãƒ«ãƒ«ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // ã‚µãƒ³ãƒ—ãƒ«è«‹æ±‚æ›¸èª­ã¿è¾¼ã¿
        async function loadSampleInvoice() {
            try {
                const response = await fetch('/api/sample-invoice');
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('demoInvoiceInput').value = result.data.text;
                }
            } catch (error) {
                showResult('ã‚µãƒ³ãƒ—ãƒ«è«‹æ±‚æ›¸èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // Progress tracking functions
        function showProgress() {
            document.getElementById('progressContainer').style.display = 'block';
            resetProgressSteps();
        }

        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        function resetProgressSteps() {
            const steps = ['commit', 'parse', 'zkp', 'verify', 'payment'];
            steps.forEach(step => {
                const element = document.getElementById(`step-${step}`);
                element.className = 'progress-step pending';
                document.getElementById(`details-${step}`).textContent = getDefaultMessage(step);
            });
        }

        function updateProgressStep(step, status, message, details = null) {
            const element = document.getElementById(`step-${step}`);
            const detailsElement = document.getElementById(`details-${step}`);
            
            if (!element || !detailsElement) {
                console.warn(`Progress step elements not found: step-${step}`);
                return;
            }
            
            element.className = `progress-step ${status}`;
            
            const iconElement = element.querySelector('.progress-icon');
            if (iconElement) {
                if (status === 'active') {
                    iconElement.textContent = 'â³';
                } else if (status === 'completed') {
                    iconElement.textContent = 'âœ“';
                } else if (status === 'failed') {
                    iconElement.textContent = 'âœ—';
                }
            }
            
            detailsElement.innerHTML = message;
            
            // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯ã‚’è¿½åŠ 
            if (details) {
                let linkHtml = '';
                
                if (details.txHash) {
                    const shortHash = details.txHash.substring(0, 10) + '...' + details.txHash.substring(details.txHash.length - 8);
                    linkHtml += `<br><a href="https://sepolia.basescan.org/tx/${details.txHash}" target="_blank" class="transaction-link">ğŸ”— Tx: ${shortHash}</a>`;
                }
                
                if (details.commitResult && details.commitResult.txHash) {
                    const shortHash = details.commitResult.txHash.substring(0, 10) + '...' + details.commitResult.txHash.substring(details.commitResult.txHash.length - 8);
                    linkHtml += `<br><a href="https://sepolia.basescan.org/tx/${details.commitResult.txHash}" target="_blank" class="transaction-link">ğŸ”— Commit: ${shortHash}</a>`;
                }
                
                if (details.errorTxHash) {
                    const shortHash = details.errorTxHash.substring(0, 10) + '...' + details.errorTxHash.substring(details.errorTxHash.length - 8);
                    linkHtml += `<br><a href="https://sepolia.basescan.org/tx/${details.errorTxHash}" target="_blank" class="transaction-link" style="color: #ef4444;">âŒ Error Tx: ${shortHash}</a>`;
                }
                
                if (details.localVerified) {
                    linkHtml += `<br><span style="font-size: 12px; color: #059669;">âœ“ ãƒ­ãƒ¼ã‚«ãƒ«æ¤œè¨¼æˆåŠŸ (ä»£æ›¿å®Ÿè¡Œ)</span>`;
                }
                
                if (details.blockNumber) {
                    linkHtml += `<br><span style="font-size: 12px; color: #64748b;">Block: ${details.blockNumber}</span>`;
                }
                
                detailsElement.innerHTML += linkHtml;
            }
        }

        function getDefaultMessage(step) {
            const messages = {
                'commit': 'ã‚ªãƒ³ãƒã‚§ãƒ¼ãƒ³ãƒ«ãƒ¼ãƒ«è¨˜éŒ²ã‚’æº–å‚™ä¸­...',
                'parse': 'AIè§£æã‚’å¾…æ©Ÿä¸­...',
                'zkp': 'ã‚¼ãƒ­çŸ¥è­˜è¨¼æ˜ã‚’æº–å‚™ä¸­...',
                'verify': 'Base Sepoliaæ¤œè¨¼ã‚’å¾…æ©Ÿä¸­...',
                'payment': 'æ”¯æ‰•ã„å®Ÿè¡Œã‚’å¾…æ©Ÿä¸­...'
            };
            return messages[step] || 'å‡¦ç†ã‚’å¾…æ©Ÿä¸­...';
        }

        function formatJsonViewer(obj) {
            return JSON.stringify(obj, null, 2)
                .replace(/"([^"]+)":/g, '<span class="json-key">"$1":</span>')
                .replace(/: "([^"]+)"/g, ': <span class="json-string">"$1"</span>')
                .replace(/: (\d+\.?\d*)/g, ': <span class="json-number">$1</span>')
                .replace(/: (true|false)/g, ': <span class="json-boolean">$1</span>');
        }

        function interpretZKPSignals(signals) {
            // ZKPå…¬é–‹ã‚·ã‚°ãƒŠãƒ«ã®æ„å‘³ã‚’è§£é‡ˆï¼ˆcircomå›è·¯ã®å‡ºåŠ›é †åºã«åˆã‚ã›ã¦ä¿®æ­£ï¼‰
            const checks = [
                signals[0] === '1' ? 'ç·åˆåˆ¤å®š âœ“' : 'ç·åˆåˆ¤å®š âœ—',    // isValid
                signals[1] === '1' ? 'ã‚¢ãƒ‰ãƒ¬ã‚¹èªè¨¼ âœ“' : 'ã‚¢ãƒ‰ãƒ¬ã‚¹èªè¨¼ âœ—', // addressValid
                signals[2] === '1' ? 'é‡‘é¡åˆ¶é™ âœ“' : 'é‡‘é¡åˆ¶é™ âœ—',     // amountValid
                signals[3] === '1' ? 'æ™‚é–“åˆ¶ç´„ âœ“' : 'æ™‚é–“åˆ¶ç´„ âœ—'      // timeValid
            ];
            return checks.join(' | ');
        }

        function showEnhancedResult(title, type, data) {
            const resultDiv = document.getElementById('result');
            if (!resultDiv) {
                console.error('Result div not found');
                return;
            }
            const timestamp = new Date().toLocaleString('ja-JP');
            
            let statusIcon = type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'âŒ';
            let statusText = data.success === false ? 'å‡¦ç†å®Œäº†ï¼ˆãƒ«ãƒ¼ãƒ«é•åæ¤œå‡ºï¼‰' : 'å‡¦ç†å®Œäº†';
            
            let html = `
                <div class="result-section ${type} show">
                    <h3>${statusIcon} ${title}</h3>
                    
                    <div style="margin: 20px 0;">
                        <h4>ğŸ” å®Ÿè¡Œè©³ç´°</h4>
                        <p><strong>ãƒ—ãƒ­ã‚»ã‚¹ID:</strong> ${data.processId || 'N/A'}</p>
                        <p><strong>å®Ÿè¡Œæ™‚åˆ»:</strong> ${timestamp}</p>
                        <p><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> ${statusText}</p>
                    </div>
            `;
            
            // Add violation details if present
            if (data.paymentPlan?.compliance?.isCompliant === false) {
                html += `
                    <div style="margin: 20px 0; padding: 15px; background: #fef2f2; border-radius: 8px; border-left: 4px solid #ef4444;">
                        <h4>âš ï¸ ãƒ«ãƒ¼ãƒ«é•åè©³ç´°</h4>
                        <p><strong>ZKPå…¬é–‹ã‚·ã‚°ãƒŠãƒ«:</strong> <code>[${data.paymentPlan.violationSignals?.join(', ') || 'N/A'}]</code></p>
                        <p><strong>é•åå†…å®¹:</strong> ${data.paymentPlan.compliance.violations?.[0]?.message || 'N/A'}</p>
                        <p><strong>æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</strong> ${data.paymentPlan.recommendedAction || 'N/A'}</p>
                    </div>
                `;
            }
            
            // Add transaction links if available
            let hasTransactions = false;
            let transactionHtml = '<div style="margin: 20px 0;"><h4>ğŸ”— Base Sepolia ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³</h4>';
            
            if (data.ruleCommitment?.txHash) {
                transactionHtml += `<p><strong>ãƒ«ãƒ¼ãƒ«ã‚³ãƒŸãƒƒãƒˆ:</strong> <a href="https://sepolia.basescan.org/tx/${data.ruleCommitment.txHash}" target="_blank" class="transaction-link">${data.ruleCommitment.txHash}</a></p>`;
                hasTransactions = true;
            }
            
            if (data.paymentResult?.txHash) {
                transactionHtml += `<p><strong>USDCæ”¯æ‰•ã„:</strong> <a href="https://sepolia.basescan.org/tx/${data.paymentResult.txHash}" target="_blank" class="transaction-link">${data.paymentResult.txHash}</a></p>`;
                hasTransactions = true;
            }
            
            if (data.zkpProof?.txHash) {
                transactionHtml += `<p><strong>ZKPæ¤œè¨¼:</strong> <a href="https://sepolia.basescan.org/tx/${data.zkpProof.txHash}" target="_blank" class="transaction-link">${data.zkpProof.txHash}</a></p>`;
                hasTransactions = true;
            }
            
            transactionHtml += '</div>';
            
            if (hasTransactions) {
                html += transactionHtml;
            }
            
            html += `
                    <div style="margin: 20px 0;">
                        <h4>ğŸ“‹ è©³ç´°ãƒ‡ãƒ¼ã‚¿ (JSON)</h4>
                        <div class="json-viewer">${formatJsonViewer(data)}</div>
                    </div>
                </div>
            `;
            
            resultDiv.innerHTML = html;
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°æ¥ç¶š
        let eventSource = null;
        
        function connectToLogs(processId) {
            if (eventSource) {
                eventSource.close();
            }
            
            console.log(`Connecting to SSE: /api/logs/${processId}`);
            eventSource = new EventSource(`/api/logs/${processId}`);
            
            eventSource.onopen = function(event) {
                console.log('SSE connection opened:', event);
            };
            
            eventSource.onmessage = function(event) {
                console.log('SSE message received:', event.data);
                const logData = JSON.parse(event.data);
                handleRealtimeLog(logData);
            };
            
            eventSource.onerror = function(error) {
                console.error('SSE connection error:', error);
                console.error('EventSource readyState:', eventSource.readyState);
            };
        }
        
        function handleRealtimeLog(logData) {
            const { phase, status, message, details, timestamp } = logData;
            
            console.log('Handling realtime log:', logData);
            
            if (phase === 'init') {
                console.log('SSE connection initialized');
                return;
            }
            
            // ãƒ•ã‚§ãƒ¼ã‚ºãƒãƒƒãƒ”ãƒ³ã‚°
            const phaseMap = {
                'parse': 'parse',
                'plan': 'parse', // è¨ˆç”»ç«‹æ¡ˆã‚‚è§£æãƒ•ã‚§ãƒ¼ã‚ºã«å«ã‚ã‚‹
                'zkp': 'zkp',
                'commit': 'commit',
                'verify': 'verify',
                'payment': 'payment'
            };
            
            const mappedPhase = phaseMap[phase] || phase;
            
            // è©³ç´°ãªãƒ­ã‚°æƒ…å ±ã‚’è¡¨ç¤º
            let enhancedMessage = message;
            if (details) {
                if (details.invoiceData) {
                    const invoice = details.invoiceData;
                    enhancedMessage = `è§£æå®Œäº†: ${invoice.companyName}<br/><span style="font-size: 12px; color: #059669;">ğŸ’° æ”¯æ‰•é¡: ${invoice.amount} ${invoice.currency} â†’ ${invoice.paymentAddress.substring(0, 10)}... | ä¿¡é ¼åº¦: ${invoice.confidence}</span>`;
                }
                if (details.zkpResult && details.zkpResult.publicSignals) {
                    const signals = details.zkpResult.publicSignals;
                    const signalMeaning = interpretZKPSignals(signals);
                    enhancedMessage = `ZKPè¨¼æ˜ç”Ÿæˆå®Œäº†<br/><span style="font-size: 12px; color: #059669;">âœ“ ${signalMeaning}</span>`;
                }
                if (details.commitResult && details.commitResult.txHash) {
                    enhancedMessage += `<br/><span style="font-size: 12px; color: #059669;">âœ“ ã‚ªãƒ³ãƒã‚§ãƒ¼ãƒ³ã‚³ãƒŸãƒƒãƒˆæˆåŠŸ</span>`;
                }
            }
            
            updateProgressStep(mappedPhase, status, enhancedMessage, details);
        }
        
        function disconnectLogs() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        }

        // ãƒ‡ãƒ¢å®Ÿè¡Œï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ä½¿ç”¨ç‰ˆï¼‰
        async function runDemoWithUserInput() {
            const rulesText = document.getElementById('demoRulesInput').value;
            const invoiceText = document.getElementById('demoInvoiceInput').value;

            if (!rulesText || !invoiceText) {
                showResult('ãƒ«ãƒ¼ãƒ«ã¨è«‹æ±‚æ›¸ãƒ†ã‚­ã‚¹ãƒˆã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                return;
            }

            let userRules;
            try {
                userRules = JSON.parse(rulesText);
            } catch (error) {
                showResult('ãƒ«ãƒ¼ãƒ«ã®JSONå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“: ' + error.message, 'error');
                return;
            }

            const button = document.getElementById('demoButton');
            button.disabled = true;
            button.innerHTML = '<span class="loading"></span>ãƒ‡ãƒ¢å®Ÿè¡Œä¸­...';

            // Show progress tracking
            showProgress();

            try {
                // ãƒ—ãƒ­ã‚»ã‚¹IDã‚’äº‹å‰ã«å–å¾—
                const processIdResponse = await fetch('/api/generate-process-id', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const { processId } = await processIdResponse.json();
                
                console.log(`Generated processId: ${processId}`);
                connectToLogs(processId);
                
                const response = await fetch('/api/demo/custom', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userRules: userRules,
                        invoiceText: invoiceText,
                        processId: processId
                    })
                });

                const result = await response.json();
                
                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°ã§é€²æ—ã¯æ›´æ–°ã•ã‚Œã‚‹ãŸã‚ã€çµæœã®ã¿è¡¨ç¤º
                setTimeout(() => {
                    disconnectLogs();
                    
                    if (result.success || result.data) {
                        const data = result.data || result;
                        
                        // çµæœè¡¨ç¤ºã‚’æ”¹å–„
                        const resultDiv = document.getElementById('result');
                        if (resultDiv) {
                            showEnhancedResult('ãƒ‡ãƒ¢å®Ÿè¡Œå®Œäº†ï¼', result.success ? 'success' : 'warning', data);
                        }
                        loadHistory(); // å±¥æ­´ã‚’æ›´æ–°
                    } else {
                        showResult('ãƒ‡ãƒ¢å®Ÿè¡Œå¤±æ•—: ' + result.error, 'error');
                    }
                }, 2000); // ãƒ­ã‚°ãŒå®Œå…¨ã«å±Šãã¾ã§å°‘ã—é•·ãå¾…ã¤
                
            } catch (error) {
                disconnectLogs();
                showResult('ãƒ‡ãƒ¢å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = 'ğŸš€ ãƒ‡ãƒ¢å®Ÿè¡Œ';
            }
        }

        // å±¥æ­´èª­ã¿è¾¼ã¿
        async function loadHistory() {
            try {
                const response = await fetch('/api/payment/history');
                const result = await response.json();
                
                if (result.success) {
                    displayHistory(result.data);
                } else {
                    document.getElementById('historyContainer').innerHTML = 
                        '<p style="color: #ef4444;">å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error + '</p>';
                }
            } catch (error) {
                document.getElementById('historyContainer').innerHTML = 
                    '<p style="color: #ef4444;">å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
            }
        }

        // å±¥æ­´è¡¨ç¤º
        function displayHistory(history) {
            const container = document.getElementById('historyContainer');
            
            if (history.length === 0) {
                container.innerHTML = '<p style="color: #64748b;">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            container.innerHTML = history.map(item => `
                <div class="history-item ${item.status}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>ãƒ—ãƒ­ã‚»ã‚¹: ${item.process_id}</strong>
                        <span style="color: #64748b; font-size: 0.9rem;">
                            ${new Date(item.created_at).toLocaleString('ja-JP')}
                        </span>
                    </div>
                    <div style="margin-bottom: 5px;">
                        <strong>çŠ¶æ…‹:</strong> ${getStatusText(item.status)}
                    </div>
                    ${item.amount ? `
                        <div style="margin-bottom: 5px;">
                            <strong>é‡‘é¡:</strong> ${item.amount} USDC
                        </div>
                    ` : ''}
                    ${item.to_address ? `
                        <div style="margin-bottom: 5px;">
                            <strong>å®›å…ˆ:</strong> ${item.to_address.substring(0, 10)}...${item.to_address.slice(-8)}
                        </div>
                    ` : ''}
                    ${item.tx_hash ? `
                        <div>
                            <strong>ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³:</strong> 
                            <a href="https://sepolia.basescan.org/tx/${item.tx_hash}" target="_blank" style="color: #4f46e5;">
                                ${item.tx_hash.substring(0, 10)}...${item.tx_hash.slice(-8)}
                            </a>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // çŠ¶æ…‹ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
        function getStatusText(status) {
            const statusMap = {
                'completed': 'âœ… å®Œäº†',
                'payment_failed': 'âŒ æ”¯æ‰•ã„å¤±æ•—',
                'zkp_failed': 'ğŸ”’ ZKPæ¤œè¨¼å¤±æ•—',
                'verification_failed': 'ğŸ” è¨¼æ˜æ¤œè¨¼å¤±æ•—',
                'review_required': 'âš ï¸ æ‰‹å‹•ç¢ºèªå¿…è¦',
                'error': 'ğŸ’¥ ã‚¨ãƒ©ãƒ¼'
            };
            return statusMap[status] || status;
        }

        // çµæœè¡¨ç¤º
        function showResult(message, type = 'success', data = null) {
            const resultSection = document.getElementById('resultSection');
            const resultContent = document.getElementById('resultContent');
            
            resultSection.className = `result-section show ${type}`;
            
            let content = `<p><strong>${message}</strong></p>`;
            
            if (data) {
                content += formatDetailedResult(data, type);
            }
            
            resultContent.innerHTML = content;
            
            // çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        // è©³ç´°çµæœã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDetailedResult(data, type) {
            let content = '';
            
            // å®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—ã®è¡¨ç¤º
            if (data.processId) {
                content += `<div style="margin: 15px 0; padding: 10px; background: #f8fafc; border-radius: 8px;">`;
                content += `<h4>ğŸ” å®Ÿè¡Œè©³ç´°</h4>`;
                content += `<p><strong>ãƒ—ãƒ­ã‚»ã‚¹ID:</strong> ${data.processId}</p>`;
                content += `<p><strong>å®Ÿè¡Œæ™‚åˆ»:</strong> ${new Date(data.timestamp * 1000).toLocaleString('ja-JP')}</p>`;
                content += `</div>`;
            }

            // ZKPè¨¼æ˜ã®è©³ç´°è¡¨ç¤º
            if (data.zkpProof) {
                content += formatZKPDetails(data.zkpProof);
            }

            // ãƒ«ãƒ¼ãƒ«ã‚³ãƒŸãƒƒãƒˆã®è©³ç´°è¡¨ç¤º  
            if (data.ruleCommitment || data.commitResult) {
                content += formatRuleCommitDetails(data.ruleCommitment || data.commitResult);
            }

            // æ”¯æ‰•ã„çµæœã®è©³ç´°è¡¨ç¤º
            if (data.paymentResult) {
                content += formatPaymentDetails(data.paymentResult);
            }

            // ã‚ªãƒ³ãƒã‚§ãƒ¼ãƒ³æ¤œè¨¼ã®è©³ç´°è¡¨ç¤º
            if (data.onChainVerification) {
                content += formatOnChainVerificationDetails(data.onChainVerification);
            }

            // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã®æŠ€è¡“çš„è©³ç´°
            if (type === 'error' || type === 'warning') {
                content += formatErrorDetails(data);
            }

            // ç”Ÿãƒ‡ãƒ¼ã‚¿
            content += `<details style="margin-top: 15px;">`;
            content += `<summary>ğŸ“‹ ç”Ÿãƒ‡ãƒ¼ã‚¿ (JSON)</summary>`;
            content += `<pre style="font-size: 0.8rem; max-height: 300px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>`;
            content += `</details>`;

            return content;
        }

        // ZKPè¨¼æ˜è©³ç´°ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatZKPDetails(zkpProof) {
            let content = `<div style="margin: 15px 0; padding: 10px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">`;
            content += `<h4>ğŸ”’ ZKPè¨¼æ˜è©³ç´°</h4>`;
            
            if (zkpProof.isValid !== undefined) {
                content += `<p><strong>è¨¼æ˜æœ‰åŠ¹æ€§:</strong> ${zkpProof.isValid ? 'âœ… æœ‰åŠ¹' : 'âŒ ç„¡åŠ¹'}</p>`;
            }
            
            if (zkpProof.verified !== undefined) {
                content += `<p><strong>æ¤œè¨¼çµæœ:</strong> ${zkpProof.verified ? 'âœ… æ¤œè¨¼æˆåŠŸ' : 'âŒ æ¤œè¨¼å¤±æ•—'}</p>`;
            }

            if (zkpProof.onChain) {
                content += `<p><strong>æ¤œè¨¼æ–¹å¼:</strong> ğŸ”— ã‚ªãƒ³ãƒã‚§ãƒ¼ãƒ³æ¤œè¨¼</p>`;
                if (zkpProof.txHash) {
                    content += `<p><strong>æ¤œè¨¼TX:</strong> <a href="https://sepolia.basescan.org/tx/${zkpProof.txHash}" target="_blank" style="color: #0ea5e9;">`;
                    content += `${zkpProof.txHash.substring(0, 10)}...${zkpProof.txHash.slice(-8)}</a></p>`;
                }
                if (zkpProof.proofId) {
                    content += `<p><strong>è¨¼æ˜ID:</strong> <code style="font-size: 0.8rem;">${zkpProof.proofId}</code></p>`;
                }
            } else {
                content += `<p><strong>æ¤œè¨¼æ–¹å¼:</strong> ğŸ’» ãƒ­ãƒ¼ã‚«ãƒ«æ¤œè¨¼</p>`;
            }

            content += `</div>`;
            return content;
        }

        // ãƒ«ãƒ¼ãƒ«ã‚³ãƒŸãƒƒãƒˆè©³ç´°ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatRuleCommitDetails(commitResult) {
            let content = `<div style="margin: 15px 0; padding: 10px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #22c55e;">`;
            content += `<h4>ğŸ” ãƒ«ãƒ¼ãƒ«ã‚³ãƒŸãƒƒãƒˆè©³ç´°</h4>`;
            
            if (commitResult.success) {
                content += `<p><strong>ã‚³ãƒŸãƒƒãƒˆçŠ¶æ…‹:</strong> âœ… æˆåŠŸ</p>`;
            } else {
                content += `<p><strong>ã‚³ãƒŸãƒƒãƒˆçŠ¶æ…‹:</strong> âŒ å¤±æ•—</p>`;
            }

            if (commitResult.ruleHash) {
                content += `<p><strong>ãƒ«ãƒ¼ãƒ«ãƒãƒƒã‚·ãƒ¥:</strong> <code style="font-size: 0.8rem;">${commitResult.ruleHash}</code></p>`;
            }

            if (commitResult.txHash) {
                content += `<p><strong>ã‚³ãƒŸãƒƒãƒˆTX:</strong> <a href="https://sepolia.basescan.org/tx/${commitResult.txHash}" target="_blank" style="color: #22c55e;">`;
                content += `${commitResult.txHash.substring(0, 10)}...${commitResult.txHash.slice(-8)}</a></p>`;
            } else if (commitResult.local) {
                content += `<p><strong>ã‚³ãƒŸãƒƒãƒˆæ–¹å¼:</strong> ğŸ’» ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆæœªãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰</p>`;
            }

            content += `</div>`;
            return content;
        }

        // æ”¯æ‰•ã„è©³ç´°ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatPaymentDetails(paymentResult) {
            let content = `<div style="margin: 15px 0; padding: 10px; background: #fefce8; border-radius: 8px; border-left: 4px solid #eab308;">`;
            content += `<h4>ğŸ’° USDCæ”¯æ‰•ã„è©³ç´°</h4>`;
            
            if (paymentResult.success) {
                content += `<p><strong>æ”¯æ‰•ã„çŠ¶æ…‹:</strong> âœ… æˆåŠŸ</p>`;
            } else {
                content += `<p><strong>æ”¯æ‰•ã„çŠ¶æ…‹:</strong> âŒ å¤±æ•—</p>`;
            }

            if (paymentResult.txHash) {
                content += `<p><strong>æ”¯æ‰•ã„TX:</strong> <a href="https://sepolia.basescan.org/tx/${paymentResult.txHash}" target="_blank" style="color: #eab308;">`;
                content += `${paymentResult.txHash.substring(0, 10)}...${paymentResult.txHash.slice(-8)}</a></p>`;
            }

            if (paymentResult.amount) {
                content += `<p><strong>æ”¯æ‰•ã„é‡‘é¡:</strong> ${paymentResult.amount} USDC</p>`;
            }

            if (paymentResult.toAddress) {
                content += `<p><strong>æ”¯æ‰•ã„å…ˆ:</strong> <code>${paymentResult.toAddress.substring(0, 10)}...${paymentResult.toAddress.slice(-8)}</code></p>`;
            }

            if (paymentResult.gasUsed) {
                content += `<p><strong>ã‚¬ã‚¹ä½¿ç”¨é‡:</strong> ${paymentResult.gasUsed.toLocaleString()} gas</p>`;
            }

            content += `</div>`;
            return content;
        }

        // ã‚ªãƒ³ãƒã‚§ãƒ¼ãƒ³æ¤œè¨¼è©³ç´°ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatOnChainVerificationDetails(verification) {
            let content = `<div style="margin: 15px 0; padding: 10px; background: #f3e8ff; border-radius: 8px; border-left: 4px solid #a855f7;">`;
            content += `<h4>â›“ï¸ ã‚ªãƒ³ãƒã‚§ãƒ¼ãƒ³æ¤œè¨¼è©³ç´°</h4>`;
            
            if (verification.verified) {
                content += `<p><strong>æ¤œè¨¼çµæœ:</strong> âœ… æ¤œè¨¼æˆåŠŸ</p>`;
            } else {
                content += `<p><strong>æ¤œè¨¼çµæœ:</strong> âŒ æ¤œè¨¼å¤±æ•—</p>`;
            }

            if (verification.onChain) {
                content += `<p><strong>æ¤œè¨¼æ–¹å¼:</strong> ğŸ”— ã‚ªãƒ³ãƒã‚§ãƒ¼ãƒ³</p>`;
                if (verification.txHash) {
                    content += `<p><strong>æ¤œè¨¼TX:</strong> <a href="https://sepolia.basescan.org/tx/${verification.txHash}" target="_blank" style="color: #a855f7;">`;
                    content += `${verification.txHash.substring(0, 10)}...${verification.txHash.slice(-8)}</a></p>`;
                }
            } else {
                content += `<p><strong>æ¤œè¨¼æ–¹å¼:</strong> ğŸ’» ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰</p>`;
            }

            content += `</div>`;
            return content;
        }

        // ã‚¨ãƒ©ãƒ¼è©³ç´°ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatErrorDetails(data) {
            let content = `<div style="margin: 15px 0; padding: 10px; background: #fef2f2; border-radius: 8px; border-left: 4px solid #ef4444;">`;
            content += `<h4>ğŸš¨ æŠ€è¡“çš„ã‚¨ãƒ©ãƒ¼è©³ç´°</h4>`;
            
            // ZKPå…¬é–‹ã‚·ã‚°ãƒŠãƒ«ã®è¡¨ç¤º
            if (data.zkpProof && data.zkpProof.publicSignals) {
                content += `<p><strong>ZKPå…¬é–‹ã‚·ã‚°ãƒŠãƒ«:</strong></p>`;
                content += `<div style="font-family: monospace; background: #1e293b; color: #e2e8f0; padding: 10px; border-radius: 4px; margin: 5px 0;">`;
                content += `[${data.zkpProof.publicSignals.join(', ')}]`;
                content += `</div>`;
                content += `<p style="font-size: 0.9rem; color: #64748b;">`;
                content += `[isValid, addressValid, amountValid, timeValid] - å…¨ã¦1ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™`;
                content += `</p>`;
            }

            // ãƒ«ãƒ¼ãƒ«é•åã®è©³ç´°
            if (data.paymentPlan && data.paymentPlan.riskFactors) {
                content += `<p><strong>ãƒ«ãƒ¼ãƒ«é•åè¦å› :</strong></p>`;
                content += `<ul>`;
                data.paymentPlan.riskFactors.forEach(factor => {
                    content += `<li>${factor}</li>`;
                });
                content += `</ul>`;
            }

            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if (data.error) {
                content += `<p><strong>ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong> ${data.error}</p>`;
            }

            content += `</div>`;
            return content;
        }
    </script>
</body>
</html> 