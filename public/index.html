<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Control by ZK - „Éá„É¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .status-section {
            margin-bottom: 40px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border-left: 4px solid #4f46e5;
        }

        .demo-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5rem;
            color: #1e293b;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: #4f46e5;
            margin-right: 12px;
            border-radius: 2px;
        }

        .button {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .button.secondary {
            background: #64748b;
        }

        .button.success {
            background: #10b981;
        }

        .button.danger {
            background: #ef4444;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #4f46e5;
        }

        .form-textarea {
            resize: vertical;
            min-height: 120px;
        }

        .result-section {
            margin-top: 30px;
            padding: 20px;
            background: #f1f5f9;
            border-radius: 12px;
            display: none;
        }

        .result-section.show {
            display: block;
        }

        .result-section.success {
            background: #ecfdf5;
            border-left: 4px solid #10b981;
        }

        .result-section.error {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
        }

        .result-section.warning {
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
        }

        /* Progress Tracking Styles */
        .progress-container {
            margin: 20px 0;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .progress-step {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .progress-step.pending {
            background: #f1f5f9;
            color: #64748b;
        }

        .progress-step.active {
            background: #dbeafe;
            color: #1d4ed8;
            border-left: 4px solid #3b82f6;
        }

        .progress-step.completed {
            background: #ecfdf5;
            color: #059669;
            border-left: 4px solid #10b981;
        }

        .progress-step.failed {
            background: #fef2f2;
            color: #dc2626;
            border-left: 4px solid #ef4444;
        }

        .progress-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 12px;
        }

        .progress-step.pending .progress-icon {
            background: #e2e8f0;
        }

        .progress-step.active .progress-icon {
            background: #3b82f6;
            color: white;
        }

        .progress-step.completed .progress-icon {
            background: #10b981;
            color: white;
        }

        .progress-step.failed .progress-icon {
            background: #ef4444;
            color: white;
        }

        .step-details {
            margin-left: 32px;
            margin-top: 8px;
            font-size: 14px;
            color: #64748b;
        }

        .transaction-link {
            color: #3b82f6;
            text-decoration: none;
            font-family: monospace;
            font-size: 12px;
        }

        .transaction-link:hover {
            text-decoration: underline;
        }

        .json-viewer {
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin-top: 12px;
        }

        .json-key {
            color: #7dd3fc;
        }

        .json-string {
            color: #86efac;
        }

        .json-number {
            color: #fbbf24;
        }

        .json-boolean {
            color: #f472b6;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .status-card {
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-indicator.online {
            background: #10b981;
        }

        .status-indicator.offline {
            background: #ef4444;
        }

        .status-indicator.unknown {
            background: #64748b;
        }

        .history-section {
            margin-top: 40px;
        }

        .history-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #e5e7eb;
        }

        .history-item.completed {
            border-left-color: #10b981;
        }

        .history-item.failed {
            border-left-color: #ef4444;
        }

        .history-item.pending {
            border-left-color: #f59e0b;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 30px;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #4f46e5;
            border-bottom: 2px solid #4f46e5;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ AI Control by ZK</h1>
            <p>AI„Ç®„Éº„Ç∏„Çß„É≥„Éà„Å´„Çà„ÇãËá™ÂãïÊîØÊâï„ÅÑ„ÇíZKP„ÅßÂà∂Âæ°„Åô„Çã„Éá„É¢„Ç∑„Çπ„ÉÜ„É†</p>
        </div>

        <div class="content">
            <!-- „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="status-section">
                <h2 class="section-title">üìä „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã</h2>
                <button class="button secondary" onclick="checkStatus()">Áä∂ÊÖãÊõ¥Êñ∞</button>
                <div id="systemStatus" class="status-grid">
                    <div class="status-card">
                        <div><span class="status-indicator unknown"></span>ÂàùÊúüÂåñ‰∏≠...</div>
                    </div>
                </div>
            </div>

            <!-- „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('demo')">üéØ „Éá„É¢ÂÆüË°å</button>
                <button class="tab" onclick="showTab('history')">üìä Â±•Ê≠¥</button>
            </div>

            <!-- „Éá„É¢„Çø„Éñ -->
            <div id="demo-tab" class="tab-content active">
                <div class="demo-section">
                    <h2 class="section-title">üéØ „Éá„É¢ÂÆüË°å</h2>
                    <p style="margin-bottom: 20px; color: #64748b;">
                        ÂÆåÂÖ®„Å™„Éï„É≠„Éº„Çí„ÉÜ„Çπ„Éà„Åó„Åæ„ÅôÔºö„É´„Éº„É´„Ç≥„Éü„ÉÉ„Éà ‚Üí Ë´ãÊ±ÇÊõ∏Ëß£Êûê ‚Üí ZKPË®ºÊòé ‚Üí „Ç™„É≥„ÉÅ„Çß„Éº„É≥Ê§úË®º ‚Üí Base SepoliaÊîØÊâï„ÅÑ
                    </p>
                    
                    <div class="form-group">
                        <label class="form-label">ÊîØÊâï„ÅÑ„É´„Éº„É´Ë®≠ÂÆö:</label>
                        <button class="button secondary" onclick="loadSampleRules()">„Çµ„É≥„Éó„É´„É´„Éº„É´Ë™≠Ëæº</button>
                        <textarea class="form-textarea" id="demoRulesInput" placeholder="„É´„Éº„É´„ÇíJSONÂΩ¢Âºè„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ë´ãÊ±ÇÊõ∏„ÉÜ„Ç≠„Çπ„Éà:</label>
                        <button class="button secondary" onclick="loadSampleInvoice()">„Çµ„É≥„Éó„É´Ë´ãÊ±ÇÊõ∏Ë™≠Ëæº</button>
                        <textarea class="form-textarea" id="demoInvoiceInput" placeholder="Ë´ãÊ±ÇÊõ∏„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
                    </div>
                    
                    <button class="button" onclick="runDemoWithUserInput()" id="demoButton">
                        üöÄ „Éá„É¢ÂÆüË°å
                    </button>
                </div>

                <!-- Progress Tracking -->
                <div id="progressContainer" class="progress-container" style="display: none;">
                    <h3>üîÑ ÂÆüË°åÈÄ≤Êçó</h3>
                    <div id="progressSteps">
                        <div id="step-commit" class="progress-step pending">
                            <div class="progress-icon">1</div>
                            <div>
                                <strong>„É´„Éº„É´„Ç≥„Éü„ÉÉ„Éà</strong>
                                <div class="step-details" id="details-commit">„Ç™„É≥„ÉÅ„Çß„Éº„É≥„É´„Éº„É´Ë®òÈå≤„ÇíÊ∫ñÂÇô‰∏≠...</div>
                            </div>
                        </div>
                        <div id="step-parse" class="progress-step pending">
                            <div class="progress-icon">2</div>
                            <div>
                                <strong>Ë´ãÊ±ÇÊõ∏Ëß£Êûê</strong>
                                <div class="step-details" id="details-parse">AIËß£Êûê„ÇíÂæÖÊ©ü‰∏≠...</div>
                            </div>
                        </div>
                        <div id="step-zkp" class="progress-step pending">
                            <div class="progress-icon">3</div>
                            <div>
                                <strong>ZKPË®ºÊòéÁîüÊàê</strong>
                                <div class="step-details" id="details-zkp">„Çº„É≠Áü•Ë≠òË®ºÊòé„ÇíÊ∫ñÂÇô‰∏≠...</div>
                            </div>
                        </div>
                        <div id="step-verify" class="progress-step pending">
                            <div class="progress-icon">4</div>
                            <div>
                                <strong>„Ç™„É≥„ÉÅ„Çß„Éº„É≥Ê§úË®º</strong>
                                <div class="step-details" id="details-verify">Base SepoliaÊ§úË®º„ÇíÂæÖÊ©ü‰∏≠...</div>
                            </div>
                        </div>
                        <div id="step-payment" class="progress-step pending">
                            <div class="progress-icon">5</div>
                            <div>
                                <strong>USDCÊîØÊâï„ÅÑ</strong>
                                <div class="step-details" id="details-payment">ÊîØÊâï„ÅÑÂÆüË°å„ÇíÂæÖÊ©ü‰∏≠...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Â±•Ê≠¥„Çø„Éñ -->
            <div id="history-tab" class="tab-content">
                <div class="history-section">
                    <h2 class="section-title">üìä ÊîØÊâï„ÅÑÂ±•Ê≠¥</h2>
                    <button class="button secondary" onclick="loadHistory()">Â±•Ê≠¥Êõ¥Êñ∞</button>
                    <div id="historyContainer">
                        <p style="color: #64748b;">Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
                    </div>
                </div>
            </div>

            <!-- ÁµêÊûúË°®Á§∫„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div id="resultSection" class="result-section">
                <h3>Âá¶ÁêÜÁµêÊûú</h3>
                <div id="resultContent"></div>
            </div>
        </div>
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentTab = 'demo';

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            checkStatus();
            loadHistory();
        });

        // „Çø„ÉñÂàá„ÇäÊõø„Åà
        function showTab(tabName) {
            // „Çø„Éñ„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');

            // „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');

            currentTab = tabName;
        }

        // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØ
        async function checkStatus() {
            try {
                const response = await fetch('/api/status');
                const result = await response.json();
                
                if (result.success) {
                    displaySystemStatus(result.data);
                } else {
                    showResult('„Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + result.error, 'error');
                }
            } catch (error) {
                showResult('„Çµ„Éº„Éê„Éº„Å®„ÅÆÈÄö‰ø°„Ç®„É©„Éº: ' + error.message, 'error');
            }
        }

        // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖãË°®Á§∫
        function displaySystemStatus(status) {
            const statusContainer = document.getElementById('systemStatus');
            
            // USDCÊÆãÈ´ò„ÅÆ„ÅøË°®Á§∫
            if (status.balance !== null) {
                statusContainer.innerHTML = `
                    <div class="status-card">
                        <div>üí∞ USDCÊÆãÈ´ò</div>
                        <div style="font-size: 1.2rem; font-weight: bold; margin-top: 5px;">
                            ${status.balance} USDC
                        </div>
                    </div>
                `;
            } else {
                statusContainer.innerHTML = `
                    <div class="status-card">
                        <div>üí∞ USDCÊÆãÈ´ò</div>
                        <div style="font-size: 1.2rem; font-weight: bold; margin-top: 5px; color: #ef4444;">
                            ÂèñÂæó‰∏≠...
                        </div>
                    </div>
                `;
            }
        }

        // „Éá„É¢ÂÆüË°å
        async function runDemo() {
            const button = document.getElementById('demoButton');
            button.disabled = true;
            button.innerHTML = '<span class="loading"></span>„Éá„É¢ÂÆüË°å‰∏≠...';

            try {
                const response = await fetch('/api/demo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    showResult('„Éá„É¢ÂÆüË°åÂÆå‰∫ÜÔºÅ', 'success', result.data);
                    loadHistory(); // Â±•Ê≠¥„ÇíÊõ¥Êñ∞
                } else {
                    showResult('„Éá„É¢ÂÆüË°åÂ§±Êïó: ' + result.error, 'error');
                }
            } catch (error) {
                showResult('„Éá„É¢ÂÆüË°å„Ç®„É©„Éº: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = 'üöÄ „Éá„É¢ÂÆüË°å';
            }
        }

        // „Çµ„É≥„Éó„É´„É´„Éº„É´Ë™≠„ÅøËæº„Åø
        async function loadSampleRules() {
            try {
                const response = await fetch('/api/sample-rules');
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('demoRulesInput').value = JSON.stringify(result.data, null, 2);
                }
            } catch (error) {
                showResult('„Çµ„É≥„Éó„É´„É´„Éº„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº: ' + error.message, 'error');
            }
        }

        // „Çµ„É≥„Éó„É´Ë´ãÊ±ÇÊõ∏Ë™≠„ÅøËæº„Åø
        async function loadSampleInvoice() {
            try {
                const response = await fetch('/api/sample-invoice');
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('demoInvoiceInput').value = result.data.text;
                }
            } catch (error) {
                showResult('„Çµ„É≥„Éó„É´Ë´ãÊ±ÇÊõ∏Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº: ' + error.message, 'error');
            }
        }

        // Progress tracking functions
        function showProgress() {
            document.getElementById('progressContainer').style.display = 'block';
            resetProgressSteps();
        }

        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        function resetProgressSteps() {
            const steps = ['commit', 'parse', 'zkp', 'verify', 'payment'];
            steps.forEach(step => {
                const element = document.getElementById(`step-${step}`);
                element.className = 'progress-step pending';
                document.getElementById(`details-${step}`).textContent = getDefaultMessage(step);
            });
        }

        function updateProgressStep(step, status, message, details = null) {
            const element = document.getElementById(`step-${step}`);
            const detailsElement = document.getElementById(`details-${step}`);
            
            if (!element || !detailsElement) {
                console.warn(`Progress step elements not found: step-${step}`);
                return;
            }
            
            element.className = `progress-step ${status}`;
            
            const iconElement = element.querySelector('.progress-icon');
            if (iconElement) {
                if (status === 'active') {
                    iconElement.textContent = '‚è≥';
                } else if (status === 'completed') {
                    iconElement.textContent = '‚úì';
                } else if (status === 'failed') {
                    iconElement.textContent = '‚úó';
                }
            }
            
            detailsElement.innerHTML = message;
            
            // „Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥„É™„É≥„ÇØ„ÇíËøΩÂä†
            if (details) {
                let linkHtml = '';
                
                if (details.txHash) {
                    const shortHash = details.txHash.substring(0, 10) + '...' + details.txHash.substring(details.txHash.length - 8);
                    linkHtml += `<br><a href="https://sepolia.basescan.org/tx/${details.txHash}" target="_blank" class="transaction-link">üîó Tx: ${shortHash}</a>`;
                }
                
                if (details.commitResult && details.commitResult.txHash) {
                    const shortHash = details.commitResult.txHash.substring(0, 10) + '...' + details.commitResult.txHash.substring(details.commitResult.txHash.length - 8);
                    linkHtml += `<br><a href="https://sepolia.basescan.org/tx/${details.commitResult.txHash}" target="_blank" class="transaction-link">üîó Commit: ${shortHash}</a>`;
                }
                
                if (details.errorTxHash) {
                    const shortHash = details.errorTxHash.substring(0, 10) + '...' + details.errorTxHash.substring(details.errorTxHash.length - 8);
                    linkHtml += `<br><a href="https://sepolia.basescan.org/tx/${details.errorTxHash}" target="_blank" class="transaction-link" style="color: #ef4444;">‚ùå Error Tx: ${shortHash}</a>`;
                }
                
                if (details.localVerified) {
                    linkHtml += `<br><span style="font-size: 12px; color: #059669;">‚úì „É≠„Éº„Ç´„É´Ê§úË®ºÊàêÂäü (‰ª£ÊõøÂÆüË°å)</span>`;
                }
                
                if (details.blockNumber) {
                    linkHtml += `<br><span style="font-size: 12px; color: #64748b;">Block: ${details.blockNumber}</span>`;
                }
                
                detailsElement.innerHTML += linkHtml;
            }
        }

        function getDefaultMessage(step) {
            const messages = {
                'commit': '„Ç™„É≥„ÉÅ„Çß„Éº„É≥„É´„Éº„É´Ë®òÈå≤„ÇíÊ∫ñÂÇô‰∏≠...',
                'parse': 'AIËß£Êûê„ÇíÂæÖÊ©ü‰∏≠...',
                'zkp': '„Çº„É≠Áü•Ë≠òË®ºÊòé„ÇíÊ∫ñÂÇô‰∏≠...',
                'verify': 'Base SepoliaÊ§úË®º„ÇíÂæÖÊ©ü‰∏≠...',
                'payment': 'ÊîØÊâï„ÅÑÂÆüË°å„ÇíÂæÖÊ©ü‰∏≠...'
            };
            return messages[step] || 'Âá¶ÁêÜ„ÇíÂæÖÊ©ü‰∏≠...';
        }

        function formatJsonViewer(obj) {
            return JSON.stringify(obj, null, 2)
                .replace(/"([^"]+)":/g, '<span class="json-key">"$1":</span>')
                .replace(/: "([^"]+)"/g, ': <span class="json-string">"$1"</span>')
                .replace(/: (\d+\.?\d*)/g, ': <span class="json-number">$1</span>')
                .replace(/: (true|false)/g, ': <span class="json-boolean">$1</span>');
        }

        function interpretZKPSignals(signals) {
            // ZKPÂÖ¨Èñã„Ç∑„Ç∞„Éä„É´„ÅÆÊÑèÂë≥„ÇíËß£ÈáàÔºàcircomÂõûË∑Ø„ÅÆÂá∫ÂäõÈ†ÜÂ∫è„Å´Âêà„Çè„Åõ„Å¶‰øÆÊ≠£Ôºâ
            const checks = [
                signals[0] === '1' ? 'Á∑èÂêàÂà§ÂÆö ‚úì' : 'Á∑èÂêàÂà§ÂÆö ‚úó',    // isValid
                signals[1] === '1' ? '„Ç¢„Éâ„É¨„ÇπË™çË®º ‚úì' : '„Ç¢„Éâ„É¨„ÇπË™çË®º ‚úó', // addressValid
                signals[2] === '1' ? 'ÈáëÈ°çÂà∂Èôê ‚úì' : 'ÈáëÈ°çÂà∂Èôê ‚úó',     // amountValid
                signals[3] === '1' ? 'ÊôÇÈñìÂà∂Á¥Ñ ‚úì' : 'ÊôÇÈñìÂà∂Á¥Ñ ‚úó'      // timeValid
            ];
            return checks.join(' | ');
        }

        function showEnhancedResult(title, type, data) {
            const resultDiv = document.getElementById('result');
            if (!resultDiv) {
                console.error('Result div not found');
                return;
            }
            const timestamp = new Date().toLocaleString('ja-JP');
            
            let statusIcon = type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ùå';
            let statusText = data.success === false ? 'Âá¶ÁêÜÂÆå‰∫ÜÔºà„É´„Éº„É´ÈÅïÂèçÊ§úÂá∫Ôºâ' : 'Âá¶ÁêÜÂÆå‰∫Ü';
            
            let html = `
                <div class="result-section ${type} show">
                    <h3>${statusIcon} ${title}</h3>
                    
                    <div style="margin: 20px 0;">
                        <h4>üîç ÂÆüË°åË©≥Á¥∞</h4>
                        <p><strong>„Éó„É≠„Çª„ÇπID:</strong> ${data.processId || 'N/A'}</p>
                        <p><strong>ÂÆüË°åÊôÇÂàª:</strong> ${timestamp}</p>
                        <p><strong>„Çπ„ÉÜ„Éº„Çø„Çπ:</strong> ${statusText}</p>
                    </div>
            `;
            
            // Add violation details if present
            if (data.paymentPlan?.compliance?.isCompliant === false) {
                html += `
                    <div style="margin: 20px 0; padding: 15px; background: #fef2f2; border-radius: 8px; border-left: 4px solid #ef4444;">
                        <h4>‚ö†Ô∏è „É´„Éº„É´ÈÅïÂèçË©≥Á¥∞</h4>
                        <p><strong>ZKPÂÖ¨Èñã„Ç∑„Ç∞„Éä„É´:</strong> <code>[${data.paymentPlan.violationSignals?.join(', ') || 'N/A'}]</code></p>
                        <p><strong>ÈÅïÂèçÂÜÖÂÆπ:</strong> ${data.paymentPlan.compliance.violations?.[0]?.message || 'N/A'}</p>
                        <p><strong>Êé®Â•®„Ç¢„ÇØ„Ç∑„Éß„É≥:</strong> ${data.paymentPlan.recommendedAction || 'N/A'}</p>
                    </div>
                `;
            }
            
            // Add transaction links if available
            let hasTransactions = false;
            let transactionHtml = '<div style="margin: 20px 0;"><h4>üîó Base Sepolia „Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥</h4>';
            
            if (data.ruleCommitment?.txHash) {
                transactionHtml += `<p><strong>„É´„Éº„É´„Ç≥„Éü„ÉÉ„Éà:</strong> <a href="https://sepolia.basescan.org/tx/${data.ruleCommitment.txHash}" target="_blank" class="transaction-link">${data.ruleCommitment.txHash}</a></p>`;
                hasTransactions = true;
            }
            
            if (data.paymentResult?.txHash) {
                transactionHtml += `<p><strong>USDCÊîØÊâï„ÅÑ:</strong> <a href="https://sepolia.basescan.org/tx/${data.paymentResult.txHash}" target="_blank" class="transaction-link">${data.paymentResult.txHash}</a></p>`;
                hasTransactions = true;
            }
            
            if (data.zkpProof?.txHash) {
                transactionHtml += `<p><strong>ZKPÊ§úË®º:</strong> <a href="https://sepolia.basescan.org/tx/${data.zkpProof.txHash}" target="_blank" class="transaction-link">${data.zkpProof.txHash}</a></p>`;
                hasTransactions = true;
            }
            
            transactionHtml += '</div>';
            
            if (hasTransactions) {
                html += transactionHtml;
            }
            
            html += `
                    <div style="margin: 20px 0;">
                        <h4>üìã Ë©≥Á¥∞„Éá„Éº„Çø (JSON)</h4>
                        <div class="json-viewer">${formatJsonViewer(data)}</div>
                    </div>
                </div>
            `;
            
            resultDiv.innerHTML = html;
        }

        // „É™„Ç¢„É´„Çø„Ç§„É†„É≠„Ç∞Êé•Á∂ö
        let eventSource = null;
        
        function connectToLogs(processId) {
            if (eventSource) {
                eventSource.close();
            }
            
            console.log(`Connecting to SSE: /api/logs/${processId}`);
            eventSource = new EventSource(`/api/logs/${processId}`);
            
            eventSource.onopen = function(event) {
                console.log('SSE connection opened:', event);
            };
            
            eventSource.onmessage = function(event) {
                console.log('SSE message received:', event.data);
                const logData = JSON.parse(event.data);
                handleRealtimeLog(logData);
            };
            
            eventSource.onerror = function(error) {
                console.error('SSE connection error:', error);
                console.error('EventSource readyState:', eventSource.readyState);
            };
        }
        
        function handleRealtimeLog(logData) {
            const { phase, status, message, details, timestamp } = logData;
            
            console.log('Handling realtime log:', logData);
            
            if (phase === 'init') {
                console.log('SSE connection initialized');
                return;
            }
            
            // „Éï„Çß„Éº„Ç∫„Éû„ÉÉ„Éî„É≥„Ç∞
            const phaseMap = {
                'parse': 'parse',
                'plan': 'parse', // Ë®àÁîªÁ´ãÊ°à„ÇÇËß£Êûê„Éï„Çß„Éº„Ç∫„Å´Âê´„ÇÅ„Çã
                'zkp': 'zkp',
                'commit': 'commit',
                'verify': 'verify',
                'payment': 'payment'
            };
            
            const mappedPhase = phaseMap[phase] || phase;
            
            // Ë©≥Á¥∞„Å™„É≠„Ç∞ÊÉÖÂ†±„ÇíË°®Á§∫
            let enhancedMessage = message;
            if (details) {
                if (details.invoiceData) {
                    const invoice = details.invoiceData;
                    enhancedMessage = `Ëß£ÊûêÂÆå‰∫Ü: ${invoice.companyName}<br/><span style="font-size: 12px; color: #059669;">üí∞ ÊîØÊâïÈ°ç: ${invoice.amount} ${invoice.currency} ‚Üí ${invoice.paymentAddress.substring(0, 10)}... | ‰ø°È†ºÂ∫¶: ${invoice.confidence}</span>`;
                }
                if (details.zkpResult && details.zkpResult.publicSignals) {
                    const signals = details.zkpResult.publicSignals;
                    const signalMeaning = interpretZKPSignals(signals);
                    enhancedMessage = `ZKPË®ºÊòéÁîüÊàêÂÆå‰∫Ü<br/><span style="font-size: 12px; color: #059669;">‚úì ${signalMeaning}</span>`;
                }
                if (details.commitResult && details.commitResult.txHash) {
                    enhancedMessage += `<br/><span style="font-size: 12px; color: #059669;">‚úì „Ç™„É≥„ÉÅ„Çß„Éº„É≥„Ç≥„Éü„ÉÉ„ÉàÊàêÂäü</span>`;
                }
            }
            
            updateProgressStep(mappedPhase, status, enhancedMessage, details);
        }
        
        function disconnectLogs() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        }

        // „Éá„É¢ÂÆüË°åÔºà„É¶„Éº„Ç∂„ÉºÂÖ•Âäõ‰ΩøÁî®ÁâàÔºâ
        async function runDemoWithUserInput() {
            const rulesText = document.getElementById('demoRulesInput').value;
            const invoiceText = document.getElementById('demoInvoiceInput').value;

            if (!rulesText || !invoiceText) {
                showResult('„É´„Éº„É´„Å®Ë´ãÊ±ÇÊõ∏„ÉÜ„Ç≠„Çπ„Éà„ÅÆ‰∏°Êñπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'warning');
                return;
            }

            let userRules;
            try {
                userRules = JSON.parse(rulesText);
            } catch (error) {
                showResult('„É´„Éº„É´„ÅÆJSONÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì: ' + error.message, 'error');
                return;
            }

            const button = document.getElementById('demoButton');
            button.disabled = true;
            button.innerHTML = '<span class="loading"></span>„Éá„É¢ÂÆüË°å‰∏≠...';

            // Show progress tracking
            showProgress();

            try {
                // „Éó„É≠„Çª„ÇπID„Çí‰∫ãÂâç„Å´ÂèñÂæó
                const processIdResponse = await fetch('/api/generate-process-id', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const { processId } = await processIdResponse.json();
                
                console.log(`Generated processId: ${processId}`);
                connectToLogs(processId);
                
                const response = await fetch('/api/demo/custom', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userRules: userRules,
                        invoiceText: invoiceText,
                        processId: processId
                    })
                });

                const result = await response.json();
                
                // „É™„Ç¢„É´„Çø„Ç§„É†„É≠„Ç∞„ÅßÈÄ≤Êçó„ÅØÊõ¥Êñ∞„Åï„Çå„Çã„Åü„ÇÅ„ÄÅÁµêÊûú„ÅÆ„ÅøË°®Á§∫
                setTimeout(() => {
                    disconnectLogs();
                    
                    if (result.success || result.data) {
                        const data = result.data || result;
                        
                        // ÁµêÊûúË°®Á§∫„ÇíÊîπÂñÑ
                        const resultDiv = document.getElementById('result');
                        if (resultDiv) {
                            showEnhancedResult('„Éá„É¢ÂÆüË°åÂÆå‰∫ÜÔºÅ', result.success ? 'success' : 'warning', data);
                        }
                        loadHistory(); // Â±•Ê≠¥„ÇíÊõ¥Êñ∞
                    } else {
                        showResult('„Éá„É¢ÂÆüË°åÂ§±Êïó: ' + result.error, 'error');
                    }
                }, 2000); // „É≠„Ç∞„ÅåÂÆåÂÖ®„Å´Â±ä„Åè„Åæ„ÅßÂ∞ë„ÅóÈï∑„ÅèÂæÖ„Å§
                
            } catch (error) {
                disconnectLogs();
                showResult('„Éá„É¢ÂÆüË°å„Ç®„É©„Éº: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = 'üöÄ „Éá„É¢ÂÆüË°å';
            }
        }

        // Â±•Ê≠¥Ë™≠„ÅøËæº„Åø
        async function loadHistory() {
            try {
                const response = await fetch('/api/payment/history');
                const result = await response.json();
                
                if (result.success) {
                    displayHistory(result.data);
                } else {
                    document.getElementById('historyContainer').innerHTML = 
                        '<p style="color: #ef4444;">Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + result.error + '</p>';
                }
            } catch (error) {
                document.getElementById('historyContainer').innerHTML = 
                    '<p style="color: #ef4444;">Â±•Ê≠¥Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº: ' + error.message + '</p>';
            }
        }

        // Â±•Ê≠¥Ë°®Á§∫
        function displayHistory(history) {
            const container = document.getElementById('historyContainer');
            
            if (history.length === 0) {
                container.innerHTML = '<p style="color: #64748b;">Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            container.innerHTML = history.map(item => `
                <div class="history-item ${item.status}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>„Éó„É≠„Çª„Çπ: ${item.process_id}</strong>
                        <span style="color: #64748b; font-size: 0.9rem;">
                            ${new Date(item.created_at).toLocaleString('ja-JP')}
                        </span>
                    </div>
                    <div style="margin-bottom: 5px;">
                        <strong>Áä∂ÊÖã:</strong> ${getStatusText(item.status)}
                    </div>
                    ${item.amount ? `
                        <div style="margin-bottom: 5px;">
                            <strong>ÈáëÈ°ç:</strong> ${item.amount} USDC
                        </div>
                    ` : ''}
                    ${item.to_address ? `
                        <div style="margin-bottom: 5px;">
                            <strong>ÂÆõÂÖà:</strong> ${item.to_address.substring(0, 10)}...${item.to_address.slice(-8)}
                        </div>
                    ` : ''}
                    ${item.tx_hash ? `
                        <div>
                            <strong>„Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥:</strong> 
                            <a href="https://sepolia.basescan.org/tx/${item.tx_hash}" target="_blank" style="color: #4f46e5;">
                                ${item.tx_hash.substring(0, 10)}...${item.tx_hash.slice(-8)}
                            </a>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Áä∂ÊÖã„ÉÜ„Ç≠„Çπ„ÉàÂèñÂæó
        function getStatusText(status) {
            const statusMap = {
                'completed': '‚úÖ ÂÆå‰∫Ü',
                'payment_failed': '‚ùå ÊîØÊâï„ÅÑÂ§±Êïó',
                'zkp_failed': 'üîí ZKPÊ§úË®ºÂ§±Êïó',
                'verification_failed': 'üîç Ë®ºÊòéÊ§úË®ºÂ§±Êïó',
                'review_required': '‚ö†Ô∏è ÊâãÂãïÁ¢∫Ë™çÂøÖË¶Å',
                'error': 'üí• „Ç®„É©„Éº'
            };
            return statusMap[status] || status;
        }

        // ÁµêÊûúË°®Á§∫
        function showResult(message, type = 'success', data = null) {
            const resultSection = document.getElementById('resultSection');
            const resultContent = document.getElementById('resultContent');
            
            resultSection.className = `result-section show ${type}`;
            
            let content = `<p><strong>${message}</strong></p>`;
            
            if (data) {
                content += formatDetailedResult(data, type);
            }
            
            resultContent.innerHTML = content;
            
            // ÁµêÊûú„Çª„ÇØ„Ç∑„Éß„É≥„Åæ„Åß„Çπ„ÇØ„É≠„Éº„É´
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Ë©≥Á¥∞ÁµêÊûú„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatDetailedResult(data, type) {
            let content = '';
            
            // ÂÆüË°å„Çπ„ÉÜ„ÉÉ„Éó„ÅÆË°®Á§∫
            if (data.processId) {
                content += `<div style="margin: 15px 0; padding: 10px; background: #f8fafc; border-radius: 8px;">`;
                content += `<h4>üîç ÂÆüË°åË©≥Á¥∞</h4>`;
                content += `<p><strong>„Éó„É≠„Çª„ÇπID:</strong> ${data.processId}</p>`;
                content += `<p><strong>ÂÆüË°åÊôÇÂàª:</strong> ${new Date(data.timestamp * 1000).toLocaleString('ja-JP')}</p>`;
                content += `</div>`;
            }

            // ZKPË®ºÊòé„ÅÆË©≥Á¥∞Ë°®Á§∫
            if (data.zkpProof) {
                content += formatZKPDetails(data.zkpProof);
            }

            // „É´„Éº„É´„Ç≥„Éü„ÉÉ„Éà„ÅÆË©≥Á¥∞Ë°®Á§∫  
            if (data.ruleCommitment || data.commitResult) {
                content += formatRuleCommitDetails(data.ruleCommitment || data.commitResult);
            }

            // ÊîØÊâï„ÅÑÁµêÊûú„ÅÆË©≥Á¥∞Ë°®Á§∫
            if (data.paymentResult) {
                content += formatPaymentDetails(data.paymentResult);
            }

            // „Ç™„É≥„ÉÅ„Çß„Éº„É≥Ê§úË®º„ÅÆË©≥Á¥∞Ë°®Á§∫
            if (data.onChainVerification) {
                content += formatOnChainVerificationDetails(data.onChainVerification);
            }

            // „Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅÆÊäÄË°ìÁöÑË©≥Á¥∞
            if (type === 'error' || type === 'warning') {
                content += formatErrorDetails(data);
            }

            // Áîü„Éá„Éº„Çø
            content += `<details style="margin-top: 15px;">`;
            content += `<summary>üìã Áîü„Éá„Éº„Çø (JSON)</summary>`;
            content += `<pre style="font-size: 0.8rem; max-height: 300px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>`;
            content += `</details>`;

            return content;
        }

        // ZKPË®ºÊòéË©≥Á¥∞„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatZKPDetails(zkpProof) {
            let content = `<div style="margin: 15px 0; padding: 10px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">`;
            content += `<h4>üîí ZKPË®ºÊòéË©≥Á¥∞</h4>`;
            
            if (zkpProof.isValid !== undefined) {
                content += `<p><strong>Ë®ºÊòéÊúâÂäπÊÄß:</strong> ${zkpProof.isValid ? '‚úÖ ÊúâÂäπ' : '‚ùå ÁÑ°Âäπ'}</p>`;
            }
            
            if (zkpProof.verified !== undefined) {
                content += `<p><strong>Ê§úË®ºÁµêÊûú:</strong> ${zkpProof.verified ? '‚úÖ Ê§úË®ºÊàêÂäü' : '‚ùå Ê§úË®ºÂ§±Êïó'}</p>`;
            }

            if (zkpProof.onChain) {
                content += `<p><strong>Ê§úË®ºÊñπÂºè:</strong> üîó „Ç™„É≥„ÉÅ„Çß„Éº„É≥Ê§úË®º</p>`;
                if (zkpProof.txHash) {
                    content += `<p><strong>Ê§úË®ºTX:</strong> <a href="https://sepolia.basescan.org/tx/${zkpProof.txHash}" target="_blank" style="color: #0ea5e9;">`;
                    content += `${zkpProof.txHash.substring(0, 10)}...${zkpProof.txHash.slice(-8)}</a></p>`;
                }
                if (zkpProof.proofId) {
                    content += `<p><strong>Ë®ºÊòéID:</strong> <code style="font-size: 0.8rem;">${zkpProof.proofId}</code></p>`;
                }
            } else {
                content += `<p><strong>Ê§úË®ºÊñπÂºè:</strong> üíª „É≠„Éº„Ç´„É´Ê§úË®º</p>`;
            }

            content += `</div>`;
            return content;
        }

        // „É´„Éº„É´„Ç≥„Éü„ÉÉ„ÉàË©≥Á¥∞„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatRuleCommitDetails(commitResult) {
            let content = `<div style="margin: 15px 0; padding: 10px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #22c55e;">`;
            content += `<h4>üîê „É´„Éº„É´„Ç≥„Éü„ÉÉ„ÉàË©≥Á¥∞</h4>`;
            
            if (commitResult.success) {
                content += `<p><strong>„Ç≥„Éü„ÉÉ„ÉàÁä∂ÊÖã:</strong> ‚úÖ ÊàêÂäü</p>`;
            } else {
                content += `<p><strong>„Ç≥„Éü„ÉÉ„ÉàÁä∂ÊÖã:</strong> ‚ùå Â§±Êïó</p>`;
            }

            if (commitResult.ruleHash) {
                content += `<p><strong>„É´„Éº„É´„Éè„ÉÉ„Ç∑„É•:</strong> <code style="font-size: 0.8rem;">${commitResult.ruleHash}</code></p>`;
            }

            if (commitResult.txHash) {
                content += `<p><strong>„Ç≥„Éü„ÉÉ„ÉàTX:</strong> <a href="https://sepolia.basescan.org/tx/${commitResult.txHash}" target="_blank" style="color: #22c55e;">`;
                content += `${commitResult.txHash.substring(0, 10)}...${commitResult.txHash.slice(-8)}</a></p>`;
            } else if (commitResult.local) {
                content += `<p><strong>„Ç≥„Éü„ÉÉ„ÉàÊñπÂºè:</strong> üíª „É≠„Éº„Ç´„É´Ôºà„Ç≥„É≥„Éà„É©„ÇØ„ÉàÊú™„Éá„Éó„É≠„Ç§Ôºâ</p>`;
            }

            content += `</div>`;
            return content;
        }

        // ÊîØÊâï„ÅÑË©≥Á¥∞„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatPaymentDetails(paymentResult) {
            let content = `<div style="margin: 15px 0; padding: 10px; background: #fefce8; border-radius: 8px; border-left: 4px solid #eab308;">`;
            content += `<h4>üí∞ USDCÊîØÊâï„ÅÑË©≥Á¥∞</h4>`;
            
            if (paymentResult.success) {
                content += `<p><strong>ÊîØÊâï„ÅÑÁä∂ÊÖã:</strong> ‚úÖ ÊàêÂäü</p>`;
            } else {
                content += `<p><strong>ÊîØÊâï„ÅÑÁä∂ÊÖã:</strong> ‚ùå Â§±Êïó</p>`;
            }

            if (paymentResult.txHash) {
                content += `<p><strong>ÊîØÊâï„ÅÑTX:</strong> <a href="https://sepolia.basescan.org/tx/${paymentResult.txHash}" target="_blank" style="color: #eab308;">`;
                content += `${paymentResult.txHash.substring(0, 10)}...${paymentResult.txHash.slice(-8)}</a></p>`;
            }

            if (paymentResult.amount) {
                content += `<p><strong>ÊîØÊâï„ÅÑÈáëÈ°ç:</strong> ${paymentResult.amount} USDC</p>`;
            }

            if (paymentResult.toAddress) {
                content += `<p><strong>ÊîØÊâï„ÅÑÂÖà:</strong> <code>${paymentResult.toAddress.substring(0, 10)}...${paymentResult.toAddress.slice(-8)}</code></p>`;
            }

            if (paymentResult.gasUsed) {
                content += `<p><strong>„Ç¨„Çπ‰ΩøÁî®Èáè:</strong> ${paymentResult.gasUsed.toLocaleString()} gas</p>`;
            }

            content += `</div>`;
            return content;
        }

        // „Ç™„É≥„ÉÅ„Çß„Éº„É≥Ê§úË®ºË©≥Á¥∞„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatOnChainVerificationDetails(verification) {
            let content = `<div style="margin: 15px 0; padding: 10px; background: #f3e8ff; border-radius: 8px; border-left: 4px solid #a855f7;">`;
            content += `<h4>‚õìÔ∏è „Ç™„É≥„ÉÅ„Çß„Éº„É≥Ê§úË®ºË©≥Á¥∞</h4>`;
            
            if (verification.verified) {
                content += `<p><strong>Ê§úË®ºÁµêÊûú:</strong> ‚úÖ Ê§úË®ºÊàêÂäü</p>`;
            } else {
                content += `<p><strong>Ê§úË®ºÁµêÊûú:</strong> ‚ùå Ê§úË®ºÂ§±Êïó</p>`;
            }

            if (verification.onChain) {
                content += `<p><strong>Ê§úË®ºÊñπÂºè:</strong> üîó „Ç™„É≥„ÉÅ„Çß„Éº„É≥</p>`;
                if (verification.txHash) {
                    content += `<p><strong>Ê§úË®ºTX:</strong> <a href="https://sepolia.basescan.org/tx/${verification.txHash}" target="_blank" style="color: #a855f7;">`;
                    content += `${verification.txHash.substring(0, 10)}...${verification.txHash.slice(-8)}</a></p>`;
                }
            } else {
                content += `<p><strong>Ê§úË®ºÊñπÂºè:</strong> üíª „É≠„Éº„Ç´„É´Ôºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ</p>`;
            }

            content += `</div>`;
            return content;
        }

        // „Ç®„É©„ÉºË©≥Á¥∞„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatErrorDetails(data) {
            let content = `<div style="margin: 15px 0; padding: 10px; background: #fef2f2; border-radius: 8px; border-left: 4px solid #ef4444;">`;
            content += `<h4>üö® ÊäÄË°ìÁöÑ„Ç®„É©„ÉºË©≥Á¥∞</h4>`;
            
            // ZKPÂÖ¨Èñã„Ç∑„Ç∞„Éä„É´„ÅÆË°®Á§∫
            if (data.zkpProof && data.zkpProof.publicSignals) {
                content += `<p><strong>ZKPÂÖ¨Èñã„Ç∑„Ç∞„Éä„É´:</strong></p>`;
                content += `<div style="font-family: monospace; background: #1e293b; color: #e2e8f0; padding: 10px; border-radius: 4px; margin: 5px 0;">`;
                content += `[${data.zkpProof.publicSignals.join(', ')}]`;
                content += `</div>`;
                content += `<p style="font-size: 0.9rem; color: #64748b;">`;
                content += `[isValid, addressValid, amountValid, timeValid] - ÂÖ®„Å¶1„Åß„ÅÇ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô`;
                content += `</p>`;
            }

            // „É´„Éº„É´ÈÅïÂèç„ÅÆË©≥Á¥∞
            if (data.paymentPlan && data.paymentPlan.riskFactors) {
                content += `<p><strong>„É´„Éº„É´ÈÅïÂèçË¶ÅÂõ†:</strong></p>`;
                content += `<ul>`;
                data.paymentPlan.riskFactors.forEach(factor => {
                    content += `<li>${factor}</li>`;
                });
                content += `</ul>`;
            }

            // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏
            if (data.error) {
                content += `<p><strong>„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏:</strong> ${data.error}</p>`;
            }

            content += `</div>`;
            return content;
        }
    </script>
</body>
</html> 